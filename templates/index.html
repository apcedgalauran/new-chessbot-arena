<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ChessBot Arena</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            base03: '#002b36',
            base02: '#073642',
            base01: '#586e75',
            base00: '#657b83',
            base0: '#839496',
            base1: '#93a1a1',
            base2: '#eee8d5',
            base3: '#fdf6e3',
            yellow: '#b58900',
            orange: '#cb4b16',
            red: '#dc322f',
            magenta: '#d33682',
            violet: '#6c71c4',
            blue: '#268bd2',
            cyan: '#2aa198',
            green: '#859900',
          }
        }
      }
    }
  </script>
  <style>
    /* LCD simulator */
    .lcd-display {
      font-family: 'Courier New', monospace;
      background: #002b36; /* Base03 */
      color: #859900;      /* Green */
      border: 4px solid #073642; /* Base02 */
      border-radius: 8px;
      padding: 12px 16px;
      letter-spacing: 2px;
      font-size: 20px;
      font-weight: bold;
      line-height: 1.6;
      text-shadow: 0 0 5px rgba(133, 153, 0, 0.5);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }

    /* Board */
    .board-container {
      display: grid;
      grid-template-columns: 20px repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr) 20px;
      gap: 0;
    }
    .square { width: 100%; padding-bottom: 100%; position: relative; }
    .square.light { background-color: #eee8d5; } /* Base2 */
    .square.dark { background-color: #93a1a1; }  /* Base1 */
    .square.highlight { background-color: #b58900; opacity: 0.8; } /* Yellow */
    .piece-img {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
    }

    /* Eval bar */
    .eval-bar-container {
      width: 32px;
      height: 100%;
      background: #586e75; /* Base01 */
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .eval-bar-white {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: #fdf6e3; /* Base3 */
      transition: height 0.5s ease;
    }
    .eval-bar-black {
      position: absolute;
      top: 0;
      width: 100%;
      background: #073642; /* Base02 */
      transition: height 0.5s ease;
    }

    /* Quality badges */
    .badge-BRILLIANT  { background: #f5a623; color: #000; }
    .badge-GOOD       { background: #22c55e; color: #fff; }
    .badge-INAC       { background: #eab308; color: #000; }
    .badge-MISTAKE    { background: #f97316; color: #fff; }
    .badge-BLUNDER    { background: #ef4444; color: #fff; }

    /* Scrollbar for history */
    .history-scroll::-webkit-scrollbar { width: 6px; }
    .history-scroll::-webkit-scrollbar-track { background: #eee8d5; }
    .history-scroll::-webkit-scrollbar-thumb { background: #93a1a1; border-radius: 3px; }

    /* Button pulse for thinking */
    @keyframes pulse-dot {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    .thinking-dot:nth-child(1) { animation: pulse-dot 1.4s 0s infinite; }
    .thinking-dot:nth-child(2) { animation: pulse-dot 1.4s 0.2s infinite; }
    .thinking-dot:nth-child(3) { animation: pulse-dot 1.4s 0.4s infinite; }
  </style>
</head>
<body class="bg-base3 text-base00 min-h-screen font-sans">

  <!-- Header -->
  <header class="bg-base2 border-b border-base1 px-6 py-3 shadow-sm">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <h1 class="text-xl font-bold text-base01 tracking-wide flex items-center gap-2">
        <span class="text-2xl text-magenta">‚ôû</span> ChessBot Arena
      </h1>
      <div class="flex items-center gap-3">
        <span id="status-badge" class="px-3 py-1 rounded-full text-xs font-semibold bg-base1 text-base3">WAITING</span>
        <span id="connection-dot" class="w-2.5 h-2.5 rounded-full bg-base1" title="Serial status"></span>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- LEFT COLUMN: Board + Controls -->
      <div class="lg:col-span-7 flex flex-col items-center gap-4">

        <!-- Board wrapper with eval bar -->
        <div class="flex gap-3 items-stretch">
          <!-- Eval Bar -->
          <div class="eval-bar-container hidden md:block" style="min-height: 360px;">
            <div id="eval-bar-white" class="eval-bar-white" style="height: 50%;"></div>
          </div>

          <!-- Board -->
          <div>
            <div id="chess-board" class="board-container w-[320px] h-[340px] md:w-[480px] md:h-[500px] select-none">
              <!-- JS Injected -->
            </div>
          </div>
        </div>

        <!-- Turn indicator + thinking -->
        <div class="flex items-center gap-2 text-sm">
          <span id="turn-indicator" class="font-medium">White to move</span>
          <span id="thinking-indicator" class="hidden flex items-center gap-0.5">
            <span class="thinking-dot w-1.5 h-1.5 bg-magenta rounded-full inline-block"></span>
            <span class="thinking-dot w-1.5 h-1.5 bg-magenta rounded-full inline-block"></span>
            <span class="thinking-dot w-1.5 h-1.5 bg-magenta rounded-full inline-block"></span>
          </span>
        </div>

        <!-- Move input -->
        <div class="flex gap-2 w-full max-w-sm">
          <input id="move-input" type="text" maxlength="5" placeholder="e.g. e2e4"
            class="flex-1 px-4 py-2 bg-base2 border border-base1 rounded-lg text-base00
                   placeholder-base1 focus:border-blue focus:outline-none font-mono text-lg tracking-wider shadow-inner"
            autocomplete="off">
          <button id="btn-submit-move" onclick="submitMove()"
            class="px-5 py-2 bg-blue hover:bg-cyan text-base3 font-semibold rounded-lg
                   transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
            Send
          </button>
        </div>

        <!-- Game control buttons -->
        <div class="flex flex-wrap gap-2 justify-center">
          <button onclick="startNewGame()"
            class="px-4 py-2 bg-green hover:bg-green/80 text-base3 text-sm font-semibold rounded-lg transition shadow-sm">
            ‚ñ∂ New Game
          </button>
          <button onclick="requestHint()"
            class="px-4 py-2 bg-violet hover:bg-violet/80 text-base3 text-sm font-semibold rounded-lg transition shadow-sm">
            üí° Hint
          </button>
          <button onclick="resignGame()"
            class="px-4 py-2 bg-red hover:bg-red/80 text-base3 text-sm font-semibold rounded-lg transition shadow-sm">
            üè≥ Resign
          </button>
        </div>

        <!-- New Game Config (hidden by default) -->
        <div id="new-game-panel" class="hidden w-full max-w-sm bg-base2 rounded-lg p-4 border border-base1 shadow-lg">
          <h3 class="text-sm font-bold mb-3 text-base01">New Game Settings</h3>
          <div class="grid grid-cols-2 gap-3 text-sm">
            <div>
              <label class="text-base1 text-xs">Difficulty (1-10)</label>
              <input id="cfg-difficulty" type="number" min="1" max="10" value="5"
                class="w-full mt-1 px-3 py-1.5 bg-base3 border border-base1 rounded text-base00">
            </div>
            <div>
              <label class="text-base1 text-xs">Timer (min, 0=off)</label>
              <input id="cfg-timer" type="number" min="0" max="60" value="10"
                class="w-full mt-1 px-3 py-1.5 bg-base3 border border-base1 rounded text-base00">
            </div>
            <div>
              <label class="text-base1 text-xs">Increment (sec)</label>
              <input id="cfg-increment" type="number" min="0" max="30" value="0"
                class="w-full mt-1 px-3 py-1.5 bg-base3 border border-base1 rounded text-base00">
            </div>
            <div>
              <label class="text-base1 text-xs">Play as</label>
              <select id="cfg-color"
                class="w-full mt-1 px-3 py-1.5 bg-base3 border border-base1 rounded text-base00">
                <option value="white">White</option>
                <option value="black">Black</option>
              </select>
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button onclick="confirmStartGame()"
              class="flex-1 px-4 py-2 bg-green hover:bg-green/80 text-base3 text-sm font-semibold rounded transition">
              Start
            </button>
            <button onclick="toggleNewGamePanel(false)"
              class="px-4 py-2 bg-base1 hover:bg-base0 text-base3 text-sm rounded transition">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: LCD + Eval + History -->
      <div class="lg:col-span-5 flex flex-col gap-4">

        <!-- LCD Simulator -->
        <div class="bg-base2 rounded-lg p-4 border border-base1 shadow-md">
          <h3 class="text-xs font-bold text-base1 mb-2 uppercase tracking-wider">LCD Display</h3>
          <div class="lcd-display">
            <div id="lcd-row0" class="whitespace-pre">ChessBot Arena  </div>
            <div id="lcd-row1" class="whitespace-pre">  Ready...      </div>
          </div>
        </div>

        <!-- Timers -->
        <div class="grid grid-cols-2 gap-3">
          <div class="bg-base2 rounded-lg p-3 border border-base1 text-center shadow-sm">
            <div class="text-xs text-base1 mb-1">‚¨ú White</div>
            <div id="timer-white" class="text-2xl font-mono font-bold text-base00">10:00</div>
          </div>
          <div class="bg-base2 rounded-lg p-3 border border-base1 text-center shadow-sm">
            <div class="text-xs text-base1 mb-1">‚¨õ Black</div>
            <div id="timer-black" class="text-2xl font-mono font-bold text-base00">10:00</div>
          </div>
        </div>

        <!-- Eval + Game Info -->
        <div class="bg-base2 rounded-lg p-4 border border-base1 shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-bold text-base1 uppercase tracking-wider">Evaluation</h3>
            <span id="eval-label-badge" class="hidden px-2 py-0.5 rounded text-xs font-bold">‚Äî</span>
          </div>
          <div class="flex items-center gap-4">
            <div id="eval-emoticon" class="text-2xl font-mono text-base00">‚Äî</div>
            <div class="text-sm text-base1">
              <div>Depth: <span id="info-depth" class="text-base00 font-bold">5</span></div>
              <div>Game: <span id="info-game-id" class="text-base00 font-bold">#0</span></div>
              <div>Color: <span id="info-player-color" class="text-base00 font-bold">White</span></div>
            </div>
          </div>
          <!-- Hint display -->
          <div id="hint-display" class="hidden mt-2 px-3 py-1.5 bg-violet/10 border border-violet/30 rounded text-sm">
            üí° Hint: <span id="hint-move" class="font-mono font-bold text-violet"></span>
          </div>
        </div>

        <!-- Move History -->
        <div class="bg-base2 rounded-lg border border-base1 flex-1 min-h-0 flex flex-col shadow-sm">
          <div class="flex border-b border-base1">
            <button onclick="switchTab('moves')" id="tab-moves" class="flex-1 py-2 text-xs font-bold text-base3 bg-base01">CURRENT GAME</button>
            <button onclick="switchTab('games')" id="tab-games" class="flex-1 py-2 text-xs font-bold text-base1 hover:bg-base3">ARCHIVE</button>
          </div>
          
          <!-- Current Game Moves -->
          <div id="view-moves" class="p-4 history-scroll overflow-y-auto flex-1" style="max-height: 300px;">
            <table class="w-full text-sm">
              <thead><tr class="text-base1 text-xs"><th class="text-left w-8">#</th><th class="text-left">White</th><th class="text-left">Black</th></tr></thead>
              <tbody id="history-body"><tr><td colspan="3" class="text-base1 py-4 text-center">No moves yet</td></tr></tbody>
            </table>
          </div>

          <!-- Past Games List -->
          <div id="view-games" class="hidden p-4 history-scroll overflow-y-auto flex-1" style="max-height: 300px;">
            <div id="games-list" class="space-y-2">
              <div class="text-center text-base1 text-sm py-4">Loading...</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Game End Overlay -->
  <div id="game-end-overlay" class="hidden fixed inset-0 bg-base03/80 flex items-center justify-center z-50">
    <div class="bg-base2 rounded-xl p-8 border border-base1 text-center max-w-sm mx-4 shadow-2xl">
      <div id="end-icon" class="text-5xl mb-3 text-base00">‚ôî</div>
      <h2 id="end-title" class="text-2xl font-bold mb-2 text-base01">Game Over</h2>
      <p id="end-message" class="text-base1 mb-6">‚Äî</p>
      <div class="flex gap-3 justify-center">
        <button onclick="startNewGame(); closeEndOverlay();"
          class="px-6 py-2 bg-green hover:bg-green/80 text-base3 font-semibold rounded-lg transition">
          New Game
        </button>
        <button onclick="closeEndOverlay()"
          class="px-6 py-2 bg-base1 hover:bg-base0 text-base3 rounded-lg transition">
          Close
        </button>
      </div>
    </div>
  </div>

<script>
// ================================================================
// STATE & CONFIG
// ================================================================
let prevState = null;
let gameEndShown = null; // track which game_id's end was shown

const PIECE_SVGS = {
  'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
  'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
  'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
  'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
  'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
  'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg',
  'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
  'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
  'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
  'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
  'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
  'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg'
};

const EMOTICONS = {
  'BRILLIANT': '(*^‚ñΩ^*) Super!!',
  'GOOD':      '(o^‚ñΩ^o) Good!',
  'INAC':      '(„Éª_„Éª;) Hmm...',
  'MISTAKE':   '(T_T) Mistake..',
  'BLUNDER':   '(√ó_√ó) Blunder!!'
};

const QUALITY_COLORS = {
  'BRILLIANT': 'badge-BRILLIANT',
  'GOOD':      'badge-GOOD',
  'INAC':      'badge-INAC',
  'MISTAKE':   'badge-MISTAKE',
  'BLUNDER':   'badge-BLUNDER'
};

// ================================================================
// BOARD RENDERING
// ================================================================
function parseFEN(fen) {
  const rows = fen.split(' ')[0].split('/');
  const board = [];
  for (const row of rows) {
    const rank = [];
    for (const ch of row) {
      if (ch >= '1' && ch <= '8') {
        for (let i = 0; i < parseInt(ch); i++) rank.push(null);
      } else {
        rank.push(ch);
      }
    }
    board.push(rank);
  }
  return board;
}

function renderBoard(fen, lastMove) {
  const boardEl = document.getElementById('chess-board');
  const boardData = parseFEN(fen);
  boardEl.innerHTML = '';

  // Parse last move squares
  let hlFrom = -1, hlTo = -1;
  if (lastMove && lastMove.length >= 4) {
    const fc = lastMove.charCodeAt(0) - 97;
    const fr = 8 - parseInt(lastMove[1]);
    const tc = lastMove.charCodeAt(2) - 97;
    const tr = 8 - parseInt(lastMove[3]);
    hlFrom = fr * 8 + fc;
    hlTo = tr * 8 + tc;
  }

  // Rank labels (left side)
  for (let r = 0; r < 8; r++) {
    const label = document.createElement('div');
    label.className = 'flex items-center justify-center text-xs text-gray-500 font-bold';
    label.textContent = 8 - r;
    boardEl.appendChild(label);

    for (let c = 0; c < 8; c++) {
      const sq = document.createElement('div');
      const isLight = (r + c) % 2 === 0;
      const idx = r * 8 + c;
      const isHighlight = (idx === hlFrom || idx === hlTo);

      let cls = 'square ' + (isLight ? 'light' : 'dark');
      if (isHighlight) cls += ' highlight';
      sq.className = cls;

      const piece = boardData[r][c];
      if (piece) {
        const img = document.createElement('img');
        img.src = PIECE_SVGS[piece];
        img.className = 'piece-img';
        sq.appendChild(img);
      }

      boardEl.appendChild(sq);
    }
  }
  
  // File labels (bottom)
  boardEl.appendChild(document.createElement('div')); // corner spacer
  for (let c = 0; c < 8; c++) {
    const label = document.createElement('div');
    label.className = 'flex items-center justify-center text-xs text-gray-500 font-bold h-5';
    label.textContent = String.fromCharCode(97 + c);
    boardEl.appendChild(label);
  }
}

// ================================================================
// UI UPDATE
// ================================================================
function formatTime(totalSecs) {
  const m = Math.floor(totalSecs / 60);
  const s = totalSecs % 60;
  return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

function updateUI(s) {
  // Board
  if (!prevState || s.fen !== prevState.fen || s.last_move !== prevState.last_move) {
    renderBoard(s.fen, s.last_move);
  }

  // LCD
  document.getElementById('lcd-row0').textContent = (s.lcd[0] || '').padEnd(16).substring(0, 16);

  const inputEl = document.getElementById('move-input');
  if (inputEl.value.length > 0) {
    const txt = "Move: " + inputEl.value;
    document.getElementById('lcd-row1').textContent = txt.padEnd(16).substring(0, 16);
  } else {
    document.getElementById('lcd-row1').textContent = (s.lcd[1] || '').padEnd(16).substring(0, 16);
  }

  // Timers
  document.getElementById('timer-white').textContent = formatTime(s.timers.w || 0);
  document.getElementById('timer-black').textContent = formatTime(s.timers.b || 0);

  // Timer color: active player gets brighter styling
  const twEl = document.getElementById('timer-white');
  const tbEl = document.getElementById('timer-black');
  if (s.status === 'playing') {
    twEl.className = 'text-2xl font-mono font-bold ' + (s.turn === 'white' ? 'text-base00' : 'text-base1/50');
    tbEl.className = 'text-2xl font-mono font-bold ' + (s.turn === 'black' ? 'text-base00' : 'text-base1/50');
  }

  // Turn indicator
  const turnEl = document.getElementById('turn-indicator');
  turnEl.textContent = s.status === 'playing'
    ? (s.turn === 'white' ? 'White to move' : 'Black to move')
    : statusText(s.status, s.winner);

  // Thinking indicator
  document.getElementById('thinking-indicator').classList.toggle('hidden', !s.thinking);

  // Status badge
  const badge = document.getElementById('status-badge');
  badge.textContent = s.status.toUpperCase();
  badge.className = 'px-3 py-1 rounded-full text-xs font-semibold ' + statusBadgeColor(s.status);

  // Eval
  const evalEl = document.getElementById('eval-emoticon');
  const evalBadge = document.getElementById('eval-label-badge');
  if (s.eval.label) {
    evalEl.textContent = EMOTICONS[s.eval.label] || s.eval.label;
    evalBadge.textContent = s.eval.label;
    evalBadge.className = 'px-2 py-0.5 rounded text-xs font-bold ' + (QUALITY_COLORS[s.eval.label] || 'bg-gray-600');
    evalBadge.classList.remove('hidden');
  } else {
    evalEl.textContent = '‚Äî';
    evalBadge.classList.add('hidden');
  }

  // Eval bar
  const cp = s.eval.val || 0;
  const clampedCp = Math.max(-1000, Math.min(1000, cp));
  const pct = 50 + (clampedCp / 1000) * 50;
  const barEl = document.getElementById('eval-bar-white');
  if (barEl) barEl.style.height = pct + '%';

  // Game info
  document.getElementById('info-depth').textContent = s.settings.depth || 5;
  document.getElementById('info-game-id').textContent = '#' + (s.settings.id || 0);
  document.getElementById('info-player-color').textContent = 'White'; // Simplified

  // Hint
  const hintDisplay = document.getElementById('hint-display');
  if (s.hint_move) {
    document.getElementById('hint-move').textContent = s.hint_move.toUpperCase();
    hintDisplay.classList.remove('hidden');
  } else {
    hintDisplay.classList.add('hidden');
  }

  // Move history
  renderHistory(s.history || []);

  // Game end overlay
  if ((s.status === 'checkmate' || s.status === 'stalemate' || s.status === 'resigned' || s.status === 'draw')
      && gameEndShown !== s.settings.id) {
    gameEndShown = s.settings.id;
    showEndOverlay(s);
  }
}

function statusText(status, winner) {
  switch (status) {
    case 'waiting': return 'Waiting for game...';
    case 'playing': return 'Game in progress';
    case 'checkmate': return (winner ? winner.charAt(0).toUpperCase() + winner.slice(1) : '') + ' wins by checkmate!';
    case 'stalemate': return 'Draw by stalemate';
    case 'resigned': return (winner ? winner.charAt(0).toUpperCase() + winner.slice(1) : '') + ' wins by resignation';
    case 'draw': return 'Game drawn by agreement';
    default: return status;
  }
}

function statusBadgeColor(status) {
  switch (status) {
    case 'playing': return 'bg-green text-base3';
    case 'checkmate': return 'bg-red text-base3';
    case 'stalemate': case 'draw': return 'bg-yellow text-base3';
    case 'resigned': return 'bg-orange text-base3';
    default: return 'bg-base1 text-base3';
  }
}

function renderHistory(moves) {
  const body = document.getElementById('history-body');
  if (!moves || moves.length === 0) {
    body.innerHTML = '<tr><td colspan="3" class="text-gray-600 py-4 text-center">No moves yet</td></tr>';
    return;
  }

  let html = '';
  for (let i = 0; i < moves.length; i += 2) {
    const num = Math.floor(i / 2) + 1;
    const white = moves[i];
    const black = (i + 1 < moves.length) ? moves[i + 1] : null;

    html += '<tr class="border-b border-base1/20">';
    html += `<td class="py-1 text-base1">${num}.</td>`;
    html += `<td class="py-1">${moveCell(white)}</td>`;
    html += `<td class="py-1">${black ? moveCell(black) : ''}</td>`;
    html += '</tr>';
  }
  body.innerHTML = html;

  // Auto-scroll to bottom
  const container = body.closest('.history-scroll');
  if (container) container.scrollTop = container.scrollHeight;
}

function moveCell(m) {
  const badge = m.quality
    ? `<span class="ml-1 px-1.5 py-0.5 rounded text-[10px] font-bold ${QUALITY_COLORS[m.quality] || ''}">${m.quality}</span>`
    : '';
  return `<span class="font-mono">${m.san || m.move}</span>${badge}`;
}

function switchTab(tab) {
  document.getElementById('view-moves').classList.toggle('hidden', tab !== 'moves');
  document.getElementById('view-games').classList.toggle('hidden', tab !== 'games');
  
  document.getElementById('tab-moves').className = tab === 'moves' ? 'flex-1 py-2 text-xs font-bold text-base3 bg-base01' : 'flex-1 py-2 text-xs font-bold text-base1 hover:bg-base3';
  document.getElementById('tab-games').className = tab === 'games' ? 'flex-1 py-2 text-xs font-bold text-base3 bg-base01' : 'flex-1 py-2 text-xs font-bold text-base1 hover:bg-base3';

  if (tab === 'games') loadMatchHistory();
}

// ================================================================
async function loadMatchHistory() {
  const list = document.getElementById('games-list');
  list.innerHTML = '<div class="text-center text-gray-500 text-xs">Loading...</div>';
  
  const res = await fetch('/api/history');
  const data = await res.json();
  
  if (data.games.length === 0) {
    list.innerHTML = '<div class="text-center text-gray-500 text-sm py-4">No games played yet</div>';
    return;
  }

  list.innerHTML = data.games.map(g => `
    <div class="bg-base3 p-3 rounded border border-base1 shadow-sm hover:shadow-md transition-shadow">
      <div class="flex justify-between items-start cursor-pointer select-none" onclick="toggleGameDetails(${g.id})">
        <div>
          <div class="font-bold text-base01 text-sm">${g.result}</div>
          <div class="text-xs text-base1 mt-0.5">${new Date(g.date).toLocaleString()}</div>
          <div class="text-xs text-base00 mt-1 font-medium">${g.white_player} vs ${g.black_player}</div>
        </div>
        <div class="text-base1 transform transition-transform duration-200" id="arrow-${g.id}">‚ñº</div>
      </div>
      <div id="details-${g.id}" class="hidden mt-3 pt-2 border-t border-base1/20">
        ${formatPgnToTable(g.pgn)}
      </div>
    </div>
  `).join('');
}

function toggleGameDetails(id) {
  const el = document.getElementById(`details-${id}`);
  const arrow = document.getElementById(`arrow-${id}`);
  if (el.classList.contains('hidden')) {
    el.classList.remove('hidden');
    arrow.style.transform = 'rotate(180deg)';
  } else {
    el.classList.add('hidden');
    arrow.style.transform = 'rotate(0deg)';
  }
}

function formatPgnToTable(pgn) {
  if (!pgn) return '<div class="text-xs text-base1 italic">No moves</div>';
  const moves = pgn.trim().split(/\s+/);
  let html = '<table class="w-full text-xs table-fixed">';
  html += '<thead><tr class="text-base1 text-left border-b border-base1/20"><th class="w-8 font-normal py-1">#</th><th class="font-normal py-1">White</th><th class="font-normal py-1">Black</th></tr></thead><tbody>';
  
  for (let i = 0; i < moves.length; i += 2) {
    const num = Math.floor(i / 2) + 1;
    const w = moves[i];
    const b = moves[i+1] || '';
    html += `<tr class="border-b border-base1/10 last:border-0 hover:bg-base2/50">
      <td class="py-1 text-base1/70">${num}.</td>
      <td class="py-1 font-mono text-base00 font-semibold">${w}</td>
      <td class="py-1 font-mono text-base00 font-semibold">${b}</td>
    </tr>`;
  }
  html += '</tbody></table>';
  return html;
}

// ================================================================
// GAME END OVERLAY
// ================================================================
function showEndOverlay(s) {
  document.getElementById('game-end-overlay').classList.remove('hidden');
  const icon = document.getElementById('end-icon');
  const title = document.getElementById('end-title');
  const msg = document.getElementById('end-message');

  if (s.status === 'checkmate') {
    icon.textContent = s.winner === 'white' ? '‚ôî' : '‚ôö';
    title.textContent = 'Checkmate!';
    msg.textContent = (s.winner.charAt(0).toUpperCase() + s.winner.slice(1)) + ' wins!';
  } else if (s.status === 'stalemate') {
    icon.textContent = 'ü§ù';
    title.textContent = 'Stalemate';
    msg.textContent = 'The game is a draw.';
  } else if (s.status === 'resigned') {
    icon.textContent = 'üè≥Ô∏è';
    title.textContent = 'Resignation';
    msg.textContent = (s.winner.charAt(0).toUpperCase() + s.winner.slice(1)) + ' wins!';
  } else if (s.status === 'draw') {
    icon.textContent = 'ü§ù';
    title.textContent = 'Draw';
    msg.textContent = 'Game drawn by agreement.';
  }
}

function closeEndOverlay() {
  document.getElementById('game-end-overlay').classList.add('hidden');
}

// ================================================================
// API CALLS
// ================================================================
async function submitMove() {
  const input = document.getElementById('move-input');
  const move = input.value.trim().toLowerCase();
  if (!move) return;

  try {
    const res = await fetch('/api/move', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ move })
    });
    const data = await res.json();
    if (data.error || data.result === 'illegal') {
      flashInput('border-red-500');
    } else {
      input.value = '';
      flashInput('border-green-500');
      pollState(); // immediate refresh
    }
  } catch (e) {
    console.error('Move submit error:', e);
  }
}

function startNewGame() {
  toggleNewGamePanel(true);
}

async function confirmStartGame() {
  const diff = parseInt(document.getElementById('cfg-difficulty').value) || 5;
  const timer = parseInt(document.getElementById('cfg-timer').value) || 0;
  const inc = parseInt(document.getElementById('cfg-increment').value) || 0;
  const color = document.getElementById('cfg-color').value;

  try {
    await fetch('/api/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ difficulty: diff, timer: timer, increment: inc, player_color: color })
    });
    toggleNewGamePanel(false);
    gameEndShown = null;
    closeEndOverlay();
    pollState();
  } catch (e) {
    console.error('Start error:', e);
  }
}

async function requestHint() {
  try {
    await fetch('/api/hint', { method: 'POST' });
    pollState();
  } catch (e) {
    console.error('Hint error:', e);
  }
}

async function resignGame() {
  if (!confirm('Are you sure you want to resign?')) return;
  try {
    await fetch('/api/resign', { method: 'POST' });
    pollState();
  } catch (e) {
    console.error('Resign error:', e);
  }
}

function toggleNewGamePanel(show) {
  document.getElementById('new-game-panel').classList.toggle('hidden', !show);
}

function flashInput(colorClass) {
  const input = document.getElementById('move-input');
  input.classList.add(colorClass);
  setTimeout(() => input.classList.remove(colorClass), 600);
}

// ================================================================
// POLLING
// ================================================================
async function pollState() {
  try {
    const res = await fetch('/api/state');
    const s = await res.json();
    updateUI(s);
    prevState = s;
  } catch (e) {
    // Server unreachable ‚Äî show disconnected state
    document.getElementById('connection-dot').className = 'w-2.5 h-2.5 rounded-full bg-red';
  }
}

// Enter key submits move
document.getElementById('move-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitMove();
});

document.getElementById('move-input').addEventListener('input', function(e) {
  const val = e.target.value;
  const row1 = document.getElementById('lcd-row1');
  if (val.length > 0) {
    const txt = "Move: " + val;
    row1.textContent = txt.padEnd(16).substring(0, 16);
  } else if (prevState) {
    row1.textContent = (prevState.lcd[1] || '').padEnd(16).substring(0, 16);
  }
});

// ================================================================
// INIT
// ================================================================

// Start polling
pollState();
setInterval(pollState, 1000);

</script>
</body>
</html>
